<!DOCTYPE html>
<html>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@100;400&display=swap" rel="stylesheet">


<head>
  <meta charset="UTF-8">
  <title>RepoQA for Evaluating Long-Context Code Understanding</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.3.3/dist/echarts.min.js"></script>
  <link rel="icon" href="https://images.emojiterra.com/google/noto-emoji/unicode-15/color/1024px/1f9d1-1f4bb.png">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css">

  <style>
    body {
      font-family: "JetBrains Mono", monospace;
      background-color: #FFFFFF;
      color: #000000;
    }

    #content {
      width: 60%;
    }

    th,
    td {
      text-align: left;
      width: max-content;
    }

    th {
      background-color: #f2f2f2;
    }

    #notes {
      font-size: 1em;
    }

    #notes h3 {
      margin-top: 1em;
      font-size: 2em;
      text-align: center;
    }

    #notes li {
      font-size: 1.2em;
      font-weight: 300;
      margin: 1em;
    }

    .form-select {
      font-size: 1em;
    }

    @media screen and (max-width: 1400px) {
      body {
        font-size: 1.6vw;
      }

      #content {
        width: 100%;
      }

      h1 {
        font-size: 2em;
      }

      h2 {
        font-size: 1.6em;
      }

      h3 {
        font-size: 1.2em;
      }

      table {
        font-size: small;
      }
    }
  </style>
</head>

<body>
  <div id="content" class="container-fluid d-flex flex-column align-items-center gap-3">
    <h1 class="text-nowrap mt-5">
      <bold>üí¨ RepoQA</bold>
    </h1>
    <p class="fw-light text-nowrap"><small id="warning">üö©The <i>First</i> Benchmark for Long-Context Code
        Understanding.üö©<br></small>
    </p>
    <div class="d-flex flex-row justify-content-center gap-3">
      <a href="https://github.com/evalplus/repoqa"><img
          src="https://img.shields.io/badge/github-%23121011.svg?style=for-the-badge&logo=github&logoColor=white"
          alt="github" class="img-fluid"></a>
    </div>
    <div class="container-fluid d-flex flex-row flex-nowrap">
      <div class="container-fluid d-flex flex-column align-items-center">
        <h2 class="text-nowrap mt-5"><b>üîé Searching Needle Function</b></h2>
        <h3 class="text-nowrap mt-5">üèÜ Leaderboard for 16K Code Context</h3>
        <table id="16k" class="table table-responsive table-striped table-bordered flex-shrink-1 border border-3">
        </table>
      </div>
    </div>
  </div>

  <script>
    const contextTable = document.getElementById('16k');

    const dataUrl = "results/repoqa/16k.json";
    var xhr = new XMLHttpRequest();
    xhr.open('GET', dataUrl, false);  // false makes the request synchronous
    xhr.send();
    if (xhr.status === 200) {
      data = JSON.parse(xhr.responseText);
      data = Object.keys(data).map((key) => {
        return {
          'Model': key.split("/").pop(),
          ...data[key]
        };
      });
      console.log(data);
    } else {
      // pop up error window
      alert('Failed to load data');
    }
    const globalData = data;
    const clearTable = () => {
      contextTable.innerHTML = '';
    }

    const theaders = [
      'Model',
      'Context (16K)',
    ]

    const lang_map = {
      'python': '.py',
      'cpp': '.cpp',
      'rust': '.rs',
      'java': '.java',
      'typescript': '.ts',
      'all': 'all'
    }

    // TODO: Clean exisiting code in this function
    const displayTable = (table) => {
      // filter out Null
      // data = data.filter((row) => {
      //   return row["pass@1"][score] != null;
      // }).sort((a, b) => {
      //   return b["pass@1"][score] - a["pass@1"][score];
      // });
      var thead = document.createElement('thead');
      var headerRow = document.createElement('tr');
      // add rank
      var th = document.createElement('th');
      th.textContent = '#';
      headerRow.appendChild(th);
      // headers
      theaders.forEach(function (header) {
        var th = document.createElement('th');
        if (header == "Context (16K)") {
          th.colSpan = 2;
        }
        th.textContent = header;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      var tbody = document.createElement('tbody');
      // add rank
      var rank = 1;
      data.forEach((row) => {
        rowspan = Object.keys(row['results']).length + 1;
        eval_size = row["eval_size"];
        var dataRow = document.createElement('tr');
        var rankCell = document.createElement('td');
        rankCell.rowSpan = rowspan;
        rankCell.textContent = rank;
        dataRow.appendChild(rankCell);
        var modelCell = document.createElement('td');
        modelCell.rowSpan = rowspan;
        if (rank == 1) {
          modelCell.textContent = 'ü•á ';
        } else if (rank == 2) {
          modelCell.textContent = 'ü•à ';
        } else if (rank == 3) {
          modelCell.textContent = 'ü•â ';
        } else {
          modelCell.textContent = '';
        }
        rank++;
        var modelLink = document.createElement('a');
        modelLink.textContent = row['Model'];
        modelLink.classList.add('link-underline-primary');
        modelLink.classList.add('text-nowrap');
        modelCell.appendChild(modelLink);
        dataRow.appendChild(modelCell);
        for (var i=0; i<rowspan; i++) {
          lang = "";
          if (i==0) {
            lang="all";
          }
          else {
            lang=Object.keys(row['results'])[i-1];
            var dataRow = document.createElement('tr');
          }
          var passCell = document.createElement('td');
          passCell.textContent = lang_map[lang];
          dataRow.appendChild(passCell);
          var chartCell = document.createElement('td');
          chartCell.setAttribute('id', row['Model']+lang);
          // TODO: Improve format stuff
          chartCell.width = "90%";
          chartCell.height = "80px";
          dataRow.appendChild(chartCell);
          tbody.appendChild(dataRow);
        }
      });
      table.appendChild(tbody);
    };

    clearTable();
    displayTable(contextTable);

    var chartOption = {
      grid: {
        top: 0,
        left: -10,
        right: 10,
        bottom: 0,
        containLabel: true
      },
      xAxis: {
        type: 'value',
        boundaryGap: true,
        min: 0,
        max: eval_size,
        interval: 1024,
        splitLine: {
          show: false
        },
        axisLabel: {
          formatter: function (value) {
            if (value == 0) {
              return '0';
            }
            return value / 1024 + 'k';
          }
        }
      },
      yAxis: {
        type: 'value',
        max: 1,
        show: false
      },
      series: [{
        type: 'custom',
        renderItem: function (params, api) {
          var yValue = api.value(2);
          var start = api.coord([api.value(0), yValue]);
          var size = api.size([api.value(1), yValue]);
          var style = api.style();
          return {
            type: 'rect',
            shape: {
              x: start[0],
              y: start[1],
              width: size[0],
              height: size[1]
            },
            style: style
          };
        },
        data: []
      }],
    };
    
    var global_data = [];

    data.forEach((row) => {
      eval_size = row["eval_size"];
      rowspan = Object.keys(row['results']).length + 1;
      // TODO: fix the alignment
      for (var i=0; i<rowspan; i++) {
        lang = "";
        if (i==rowspan-1) {
          lang="all";
          var chart = echarts.init(document.getElementById(row['Model']+lang));
          var chartOption_current = chartOption;
          chartOption_current.series[0].data = global_data
          chart.setOption(chartOption_current);
        }
        else {
          lang=Object.keys(row['results'])[i];
          var chart = echarts.init(document.getElementById(row['Model']+lang));
          var data = [];
          row['results'][lang].forEach((needle) => {
            data.push([needle["position"]["token_start"], needle["position"]["token_end"]-needle["position"]["token_start"], 1, needle["is_best_similar"]]);
          });
          // TODO: Customize criteria of "success" (blue) or "failure" (red)
          data = data.map(function (item, index) {
            if (item[item.length-1]) {
              return {
                value: item,
                itemStyle: {
                  color: '#4f81bd'
                }
              };
            }
            else {
              return {
                value: item,
                itemStyle: {
                  color: '#c0504d'
                }
              };
            }
          });
          global_data = global_data.concat(data);
          var chartOption_current = chartOption;
          chartOption_current.series[0].data = data
          chart.setOption(chartOption_current);
        }
      }
    });
  </script>

</body>

</html>

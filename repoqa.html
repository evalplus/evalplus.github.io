<!DOCTYPE html>
<html>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@100;400&display=swap" rel="stylesheet">


<head>
  <meta charset="UTF-8">
  <title>RepoQA for Evaluating Long-Context Code Understanding</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.3.3/dist/echarts.min.js"></script>
  <link rel="icon" href="https://images.emojiterra.com/google/noto-emoji/unicode-15/color/1024px/1f9d1-1f4bb.png">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css">

  <style>
    body {
      font-family: "JetBrains Mono", monospace;
      background-color: #FFFFFF;
      color: #000000;
    }

    #content {
      width: 60%;
    }

    th,
    td {
      text-align: left;
      width: max-content;
    }

    th {
      background-color: #f2f2f2;
    }

    #notes {
      font-size: 1em;
    }

    #notes h3 {
      margin-top: 1em;
      font-size: 2em;
      text-align: center;
    }

    #notes li {
      font-size: 1.2em;
      font-weight: 300;
      margin: 1em;
    }

    .form-select {
      font-size: 1em;
    }

    @media screen and (max-width: 1400px) {
      body {
        font-size: 1.6vw;
      }

      #content {
        width: 100%;
      }

      h1 {
        font-size: 2em;
      }

      h2 {
        font-size: 1.6em;
      }

      h3 {
        font-size: 1.2em;
      }

      table {
        font-size: small;
      }
    }
  </style>
</head>

<body>
  <div id="content" class="container-fluid d-flex flex-column align-items-center gap-3">
    <h1 class="text-nowrap mt-5">
      <bold>üí¨ RepoQA</bold>
    </h1>
    <p class="fw-light text-nowrap"><small id="warning">üö©The <i>First</i> Benchmark for Long-Context Code
        Understanding.üö©<br></small>
    </p>
    <div class="d-flex flex-row justify-content-center gap-3">
      <a href="https://github.com/evalplus/repoqa"><img
          src="https://img.shields.io/badge/github-%23121011.svg?style=for-the-badge&logo=github&logoColor=white"
          alt="github" class="img-fluid"></a>
    </div>
    <div class="container-fluid d-flex flex-row flex-nowrap">
      <div class="container-fluid d-flex flex-column align-items-center">
        <h2 class="text-nowrap mt-5"><b>üîé Searching Needle Function</b></h2>
        <h3 class="text-nowrap mt-5">üèÜ Leaderboard for 16K Code Context</h3>
        <table id="16k" class="table table-responsive table-striped table-bordered flex-shrink-1 border border-3">
        </table>
      </div>
    </div>
  </div>

  <script>
    const contextTable = document.getElementById('16k');
    const files = [
      "codellama_slash_CodeLlama-13b-Instruct-hf-SCORES.json",
      "codellama_slash_CodeLlama-34b-Instruct-hf-SCORES.json",
      "codellama_slash_CodeLlama-7b-Instruct-hf-SCORES.json",
      "deepseek-ai_slash_deepseek-coder-33b-instruct-SCORES.json",
      "deepseek-ai_slash_deepseek-coder-6.7b-instruct-SCORES.json",
      "google_slash_codegemma-7b-it-SCORES.json",
      "meta-llama_slash_Meta-Llama-3-70B-Instruct-SCORES.json",
      "meta-llama_slash_Meta-Llama-3-8B-Instruct-SCORES.json",
      "mistralai_slash_Mistral-7B-Instruct-v0.1-SCORES.json",
      "mistralai_slash_Mistral-7B-Instruct-v0.2-SCORES.json",
      "mistralai_slash_Mixtral-8x22B-Instruct-v0.1-SCORES.json",
      "mistralai_slash_Mixtral-8x7B-Instruct-v0.1-SCORES.json",
      "Qwen_slash_CodeQwen1.5-7B-Chat-SCORES.json",
      "Qwen_slash_Qwen1.5-14B-Chat-SCORES.json",
      "Qwen_slash_Qwen1.5-32B-Chat-SCORES.json",
      "Qwen_slash_Qwen1.5-4B-Chat-SCORES.json",
      "Qwen_slash_Qwen1.5-72B-Chat-SCORES.json",
      "Qwen_slash_Qwen1.5-7B-Chat-SCORES.json",
      "Qwen_slash_Qwen1.5-MoE-A2.7B-SCORES.json",
    ];
    const dataUrlPrefix = "results/repoqa/ntoken_16384/";
    const scoreThrasold = 0.8;

    // Load data
    var data = [];
    for (var i = 0; i < files.length; i++) {
      var dataUrl = dataUrlPrefix + files[i];
      var xhr = new XMLHttpRequest();
      xhr.open('GET', dataUrl, false);  // false makes the request synchronous
      xhr.send();
      if (xhr.status === 200) {
        dataRow = JSON.parse(xhr.responseText);
        dataRow = Object.keys(dataRow).map((key) => {
          return {
            'Model': key.split("/").pop(),
            ...dataRow[key]
          };
        });
        
        // calculate the total score
        dataRow.forEach((row) => {
          var langs = Object.keys(row['scores']);
          var thrasolds = Object.keys(row['scores'][langs[0]]);
          row['scores']['total'] = {};

          for (var j = 0; j < thrasolds.length; j++) {
            totalScore = 0;
            for (var k = 0; k < langs.length; k++) {
              totalScore += row['scores'][langs[k]][thrasolds[j]]['pass@1'];
            }
            row['scores']['total'][thrasolds[j]] = totalScore / langs.length;
          }
        });

        data = data.concat(dataRow);
      } else {
        alert('Failed to load data from ' + dataUrl + '. Please try again later.');
      }
    }

    // sort by total score at [scoreThrasold]
    data.sort((a, b) => {
      return b['scores']['total'][scoreThrasold] - a['scores']['total'][scoreThrasold];
    });

    console.log("data");
    console.log(data);
    const globalData = data;

    // each row represents a model
    const theaders = [
      '#',              // rank
      'Model',          // model name
      'Context (16K)',  // context chart
      'score',          // score of each language
      'totol',          // score of all languages
    ]

    const lang_map = {
      'python': '.py',
      'cpp': '.cpp',
      'rust': '.rs',
      'java': '.java',
      'typescript': '.ts',
      'all': 'all'
    }

    const displayTable = (table) => {
      var thead = document.createElement('thead');
      var headerRow = document.createElement('tr');

      // headers
      theaders.forEach(function (header) {
        var th = document.createElement('th');
        if (header == "Context (16K)") {
          th.colSpan = 2;
        }
        th.textContent = header;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      var tbody = document.createElement('tbody');
      // add rank
      var rank = 0;
      data.forEach((row) => {
        rowspan = Object.keys(row['results']).length + 1;
        eval_size = row["eval_size"];
        var dataRow = document.createElement('tr');
        // rank
        var rankCell = document.createElement('td');
        rankCell.rowSpan = rowspan;
        rankCell.textContent = ++rank;
        dataRow.appendChild(rankCell);

        // model name
        var modelCell = document.createElement('td');
        modelCell.rowSpan = rowspan;
        if (rank == 1) {
          modelCell.textContent = 'ü•á ';
        } else if (rank == 2) {
          modelCell.textContent = 'ü•à ';
        } else if (rank == 3) {
          modelCell.textContent = 'ü•â ';
        } else {
          modelCell.textContent = '';
        }
        var modelLink = document.createElement('a');
        modelLink.textContent = row['Model'];
        modelLink.classList.add('link-underline-primary');
        modelLink.classList.add('text-nowrap');
        modelCell.appendChild(modelLink);
        dataRow.appendChild(modelCell);

        // context chart
        langs = Object.keys(row['results']);
        for (var i = 0; i < rowspan; i++) {
          // lang
          if (i == 0) {
            lang="all";
          }
          else {
            lang=langs[i-1];
            var dataRow = document.createElement('tr');
          }
          var passCell = document.createElement('td');
          passCell.textContent = lang_map[lang];
          dataRow.appendChild(passCell);

          // chart
          var chartCell = document.createElement('td');
          // TODO: Improve format stuff
          chartCell.style.width = '100%';
          chartCell.style.height = '80px';
          chartDiv = document.createElement('div');
          chartDiv.setAttribute('id', row['Model']+lang);
          chartDiv.style.width = '100%';
          chartDiv.style.height = '100%';
          chartCell.appendChild(chartDiv);
          dataRow.appendChild(chartCell);

          // score
          var scoreCell = document.createElement('td');
          scoreCell.textContent = row['scores'][lang][scoreThrasold]['pass@1'].toFixed(2);
          dataRow.appendChild(scoreCell);

          // total: average of all languages
          if (i == 0) {
            var totalScore = 0
            for (var j = 0; j < langs.length; j++) {
              totalScore += row['scores'][langs[j]][scoreThrasold]['pass@1'];
            }
            var totalCell = document.createElement('td');
            totalCell.textContent = (totalScore / langs.length).toFixed(2);
            totalCell.rowSpan = rowspan;
            dataRow.appendChild(totalCell);
          }

          tbody.appendChild(dataRow);
        }
      });
      table.appendChild(tbody);
    };

    const clearTable = () => {
      contextTable.innerHTML = '';
    }

    clearTable();
    displayTable(contextTable);

    var chartOption = {
      grid: {
        top: 0,
        left: -10,
        right: 10,
        bottom: 0,
        containLabel: true
      },
      xAxis: {
        type: 'value',
        boundaryGap: true,
        min: 0,
        max: eval_size,
        interval: 1024,
        splitLine: {
          show: false
        },
        axisLabel: {
          formatter: function (value) {
            if (value == 0) {
              return '0';
            }
            return value / 1024 + 'k';
          }
        }
      },
      yAxis: {
        type: 'value',
        max: 1,
        show: false
      },
      series: [{
        type: 'custom',
        renderItem: function (params, api) {
          var yValue = api.value(2);
          var start = api.coord([api.value(0), yValue]);
          var size = api.size([api.value(1), yValue]);
          var style = api.style();
          return {
            type: 'rect',
            shape: {
              x: start[0],
              y: start[1],
              width: size[0],
              height: size[1]
            },
            style: style
          };
        },
        data: []
      }],
    };


    data.forEach((row) => {
      var eval_size = row["eval_size"];
      var rowspan = Object.keys(row['results']).length + 1;
      var chartOption_current = chartOption;

      var global_data = [];
      for (var i = 0; i < rowspan; i++) {
        if (i==rowspan - 1) {
          lang="all";
          chartOption_current.series[0].data = global_data
        }
        else {
          lang=Object.keys(row['results'])[i];

          // prepare data of the chart
          var data = [];
          row['results'][lang].forEach((needle) => {
            data.push(
              [
                needle["position"]["token_start"], 
                needle["position"]["token_end"] - needle["position"]["token_start"], 
                1, 
                needle["is_best_similar"]
              ]
            );
          });

          // set color
          data = data.map(function (item, index) {
            if (item[item.length - 1]) { // is_best_similar
              return {
                value: item,
                itemStyle: {
                  color: '#4f81bd'      // blue
                }
              };
            }
            else {
              return {
                value: item,
                itemStyle: {
                  color: '#c0504d'
                }
              };
            }
          });

          // update global data
          global_data = global_data.concat(data);
          chartOption_current.series[0].data = data
        }
        var chart = echarts.init(document.getElementById(row['Model']+lang));
        chart.setOption(chartOption_current);
      }
    });
  </script>

</body>

</html>
